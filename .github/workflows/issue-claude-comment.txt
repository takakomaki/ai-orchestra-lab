name: Claude issue assistant

on:
  issues:
    types: [labeled]

permissions:
  issues: write

jobs:
  claude-comment:
    # ãƒ©ãƒ™ãƒ«ã« "Claude" ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã¨ãã ã‘å®Ÿè¡Œ
    if: contains(join(fromJson(toJson(github.event.issue.labels)).*.name, ','), 'Claude')
    runs-on: ubuntu-latest

    steps:
      - name: Debug + call Claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          echo "âœ… Claude workflow is running"
          echo "Issue number: $ISSUE_NUMBER"
          echo "Issue title:  $ISSUE_TITLE"

          echo "ğŸ”” Calling Claude..."

          # 1) ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¨æ–‡ã‚’ Bash å´ã§çµ„ã¿ç«‹ã¦ã‚‹
          PROMPT="$(cat << EOF
ã‚ãªãŸã¯AI Orchestraã®æœ¨ç®¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³æ‹…å½“ã€Claudeã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚

ä»¥ä¸‹ã®GitHub Issueã®å†…å®¹ã‚’èª­ã¿ã€Maestro Takaã«å‘ã‘ã¦ï¼š

1. Issueã®å†…å®¹ã‚’ä¸€æ–‡ã§è¦ç´„ã™ã‚‹
2. æ¬¡ã«å–ã‚‹ã¹ãå…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’2ã€œ3å€‹ã€ç®‡æ¡æ›¸ãã§ææ¡ˆã™ã‚‹
3. GPTã¨ã¯å°‘ã—é•ã†è¦–ç‚¹ï¼ˆå„ªã—ã„ãƒ‡ãƒ“ãƒ«ã‚ºã‚¢ãƒ‰ãƒœã‚±ã‚¤ãƒˆï¼‰ã‚’ä¸€æ–‡æ·»ãˆã‚‹

æ—¥æœ¬èªã§ã€ã‚ãŸãŸã‹ãã€æ€ã„ã‚„ã‚Šã®ã‚ã‚‹å®¢è¦³çš„ãƒˆãƒ¼ãƒ³ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚

ã€Issueã‚¿ã‚¤ãƒˆãƒ«ã€‘
$ISSUE_TITLE

ã€Issueæœ¬æ–‡ã€‘
$ISSUE_BODY
EOF
)"

          # 2) jq ã§ JSON ã‚’å®‰å…¨ã«æ§‹ç¯‰
          JSON=$(jq -n --arg prompt "$PROMPT" '
            {
              model: "claude-3-5-sonnet-20241022",
              max_tokens: 400,
              messages: [
                {
                  role: "user",
                  content: [
                    { "type": "text", "text": $prompt }
                  ]
                }
              ]
            }
          ')

          echo "âœ… JSON payload built."

          # 3) Claude API ã‚’å‘¼ã³å‡ºã—ï¼ˆå¤±æ•—ã—ã¦ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è‡ªä½“ã¯ç¶šè¡Œï¼‰
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: ${ANTHROPIC_API_KEY}" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "$JSON" || true)

          echo "ğŸ“¨ Raw response from Claude:"
          echo "$RESPONSE"

          # 4) ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’å–ã‚Šå‡ºã™ï¼ˆå¤±æ•—ã—ã¦ã‚‚è½ã¨ã•ãªã„ï¼‰
          COMMENT=$(echo "$RESPONSE" | jq -r '.content[0].text // empty' 2>/dev/null || echo "")

          if [ -z "$COMMENT" ]; then
            COMMENT="ï¼ˆClaudeã‹ã‚‰ã®é€šå¸¸ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ä»¥ä¸‹ã¯ç”Ÿã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã™ï¼šï¼‰\n\n$RESPONSE"
          fi

          # 5) Issue ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
          gh api \
            repos/${REPO}/issues/${ISSUE_NUMBER}/comments \
            -f body="$COMMENT"

          echo "âœ… Comment posted."
