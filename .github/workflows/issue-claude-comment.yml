name: Claude issue assistant

permissions:
  issues: write

on:
  issues:
    types: [labeled]

jobs:
  claude-comment:
    # ãƒ©ãƒ™ãƒ«åã« "Claude" ãŒå«ã¾ã‚Œã¦ã„ã‚‹ Issue ã ã‘åå¿œ
    if: contains(join(fromJson(toJson(github.event.issue.labels)).*.name, ','), 'Claude')
    runs-on: ubuntu-latest

    steps:
      - name: Call Claude and post comment
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          set -euo pipefail

          echo "âœ¨ Claude workflow is running"
          echo "Repository : ${REPO}"
          echo "Issue number : ${ISSUE_NUMBER}"
          echo "Issue title  : ${ISSUE_TITLE}"

          # ==== ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆçµ„ã¿ç«‹ã¦ï¼ˆBash å´ï¼‰ ====
          base_prompt=$(cat << 'EOF'
ã‚ãªãŸã¯ AI Orchestra ã®æœ¨ç®¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³æ‹…å½“ã€Claude ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚

ä»¥ä¸‹ã® GitHub Issue ã‚’èª­ã¿ã€Maestro Taka ã«å‘ã‘ã¦ï¼š

1. Issue ã®å†…å®¹ã‚’ä¸€æ–‡ã§ã‚„ã•ã—ãè¦ç´„ã™ã‚‹
2. æ¬¡ã«å–ã‚‹ã¹ãå…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ 2ã€œ3 å€‹ã€ç®‡æ¡æ›¸ãã§ææ¡ˆã™ã‚‹
3. GPT ã¨ã¯å°‘ã—é•ã†è¦–ç‚¹ï¼ˆå„ªã—ã„ãƒ‡ãƒ“ãƒ«ã‚ºã‚¢ãƒ‰ãƒœã‚±ã‚¤ãƒˆï¼‰ã‚’ä¸€æ–‡æ·»ãˆã‚‹

æ—¥æœ¬èªã§ã€ã‚ãŸãŸã‹ãã€æ€ã„ã‚„ã‚Šã®ã‚ã‚‹å®¢è¦³çš„ãƒˆãƒ¼ãƒ³ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚

ã€Issueã‚¿ã‚¤ãƒˆãƒ«ã€‘
EOF
)

          prompt="${base_prompt}
${ISSUE_TITLE}

ã€Issueæœ¬æ–‡ã€‘
${ISSUE_BODY}
"

          # ==== JSON ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ jq ã§å®‰å…¨ã«æ§‹ç¯‰ ====
          json=$(jq -n --arg prompt "$prompt" '
            {
              "model": "claude-3-5-sonnet-20241022",
              "max_tokens": 400,
              "messages": [
                {
                  "role": "user",
                  "content": [
                    { "type": "text", "text": $prompt }
                  ]
                }
              ]
            }
          ')

          echo "ğŸ“¦ JSON payload built."
          echo "$json"

          # ==== Claude API å‘¼ã³å‡ºã— ====
          response=$(curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: ${ANTHROPIC_API_KEY}" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "$json")

          echo "ğŸŸ¦ Raw response from Claude:"
          echo "$response"

          # ==== Claude ã®è¿”ç­”ãƒ†ã‚­ã‚¹ãƒˆã‚’å–ã‚Šå‡ºã™ ====
          content=$(echo "$response" | jq -r '.content[0].text // empty')

          if [ -z "$content" ]; then
            content="ï¼ˆClaude ã‹ã‚‰ã®å›ç­”ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ï¼‰"
          fi

          # ==== Issue ã«ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿ ====
          gh api \
            repos/${REPO}/issues/${ISSUE_NUMBER}/comments \
            -f body="$content"

          echo "âœ… Comment posted to issue #${ISSUE_NUMBER}"
